<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cortex.webgl.view &#8212; pycortex 1.2.10 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../../../_static/documentation_options.js?v=12f20e84"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cortex.webgl.view</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">NoOptionError</span>

<span class="c1"># Now assumes python 3</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">web</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">volume</span>
<span class="kn">from</span> <span class="nn">..database</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Package</span>
<span class="kn">from</span> <span class="nn">.FallbackLoader</span> <span class="kn">import</span> <span class="n">FallbackLoader</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">cmapdir</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;webgl&#39;</span><span class="p">,</span> <span class="s1">&#39;colormaps&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmapdir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Colormap directory (</span><span class="si">%s</span><span class="s2">) does not exist&quot;</span><span class="o">%</span><span class="n">cmapdir</span><span class="p">)</span>
<span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
    <span class="n">cmapdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;filestore&quot;</span><span class="p">),</span> <span class="s2">&quot;colormaps&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cmapdir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Colormap directory was not defined in the config file and the default (</span><span class="si">%s</span><span class="s2">) does not exist&quot;</span><span class="o">%</span><span class="n">cmapdir</span><span class="p">)</span>

<span class="n">domain_name</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;webgl&quot;</span><span class="p">,</span> <span class="s2">&quot;domain_name&quot;</span><span class="p">)</span>

<span class="n">colormaps</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmapdir</span><span class="p">,</span> <span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
<span class="n">colormaps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cm</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="n">serve</span><span class="o">.</span><span class="n">make_base64</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
             <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">colormaps</span><span class="p">)]</span>

<div class="viewcode-block" id="make_static">
<a class="viewcode-back" href="../../../generated/cortex.webgl.make_static.html#cortex.webgl.make_static">[docs]</a>
<span class="k">def</span> <span class="nf">make_static</span><span class="p">(</span>
    <span class="n">outpath</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;static.html&quot;</span><span class="p">,</span>
    <span class="n">anonymize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overlays_available</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overlays_visible</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rois&quot;</span><span class="p">,</span> <span class="s2">&quot;sulci&quot;</span><span class="p">),</span>
    <span class="n">labels_visible</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rois&quot;</span><span class="p">,),</span>
    <span class="n">types</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inflated&quot;</span><span class="p">,),</span>
    <span class="n">html_embed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">copy_ctmfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Brain&quot;</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overlay_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_brightness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_smoothness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">surface_specularity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a static webGL MRI viewer in your filesystem so that it can easily</span>
<span class="sd">    be posted publicly for sharing or just saved for later viewing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    outpath : string</span>
<span class="sd">        The directory where the static viewer will be saved. Will be created if it</span>
<span class="sd">        doesn&#39;t already exist.</span>
<span class="sd">    data : Dataset object or implicit Dataset</span>
<span class="sd">        Dataset object containing all the data you wish to plot. Can be any type</span>
<span class="sd">        of implicit dataset, such as a single Volume, Vertex, etc. object or a</span>
<span class="sd">        dictionary of Volume, Vertex. etc. objects.</span>
<span class="sd">    recache : bool, optional</span>
<span class="sd">        Force recreation of CTM and SVG files for surfaces. Default False</span>
<span class="sd">    template : string, optional</span>
<span class="sd">        Name of template HTML file. Default &#39;static.html&#39;</span>
<span class="sd">    anonymize : bool, optional</span>
<span class="sd">        Whether to rename CTM and SVG files generically, for public distribution.</span>
<span class="sd">        Default False</span>
<span class="sd">    overlays_available : tuple, optional</span>
<span class="sd">        Overlays available in the viewer. If None, then all overlay layers of the</span>
<span class="sd">        svg file will be potentially available in the viewer (whether initially</span>
<span class="sd">        visible or not). This provides the option to include, e.g., only a subset</span>
<span class="sd">        of layers for a given static viewer.</span>
<span class="sd">    overlays_visible : tuple, optional</span>
<span class="sd">        The listed overlay layers will be set visible by default. Layers not listed</span>
<span class="sd">        here will be hidden by default (but can be enabled in the viewer GUI).</span>
<span class="sd">        Default (&#39;rois&#39;, &#39;sulci&#39;)</span>
<span class="sd">    labels_visible : tuple, optional</span>
<span class="sd">        Labels for the listed layers will be set visible by default. Labels for</span>
<span class="sd">        layers not listed here will be hidden by default (but can be enabled in</span>
<span class="sd">        the viewer GUI). Default (&#39;rois&#39;, )</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    types : tuple, optional</span>
<span class="sd">        Types of surfaces to include in addition to the original (fiducial, pial,</span>
<span class="sd">        and white matter) and flat surfaces. Default (&#39;inflated&#39;, )</span>
<span class="sd">    html_embed : bool, optional</span>
<span class="sd">        Whether to embed the webgl resources in the html output.  Default &#39;True&#39;.</span>
<span class="sd">        If &#39;False&#39;, the webgl resources must be served by your web server.</span>
<span class="sd">    copy_ctmfiles : bool, optional</span>
<span class="sd">        Whether to copy the CTM files to the static directory.  Default &#39;True&#39;.</span>
<span class="sd">        In some use cases, the same CTM data will be used in many static views. To</span>
<span class="sd">        avoid duplication of files, set to &#39;False&#39;.  (The datastore cache must</span>
<span class="sd">        then be served with your web server).</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        The title that is displayed on the viewer website when it is loaded in</span>
<span class="sd">        a browser.</span>
<span class="sd">    layout : None or list of (int, int)</span>
<span class="sd">        The layout of the viewer subwindows for showing multiple subjects, passed to</span>
<span class="sd">        the template generator.</span>
<span class="sd">        Default to None, corresponding to no subwindows.</span>
<span class="sd">    overlay_file : str or None, optional</span>
<span class="sd">        Custom overlays.svg file to use instead of the default one for this</span>
<span class="sd">        subject (if not None). Default None.</span>
<span class="sd">    curvature_brightness : float or None, optional</span>
<span class="sd">        Brightness of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    curvature_contrast : float or None, optional</span>
<span class="sd">        Contrast of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    curvature_smoothness : float or None, optional</span>
<span class="sd">        Smoothness of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    surface_specularity : float or None, optional</span>
<span class="sd">        Specularity of surfaces visualized with the WebGL viewer. </span>
<span class="sd">        Default None, which uses the value specified in the config file under</span>
<span class="sd">        `webgl_viewopts.specularity`.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        All additional keyword arguments are passed to the template renderer.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    You will need a real web server to view this, since `file://` paths</span>
<span class="sd">    don&#39;t handle xsrf correctly</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">outpath</span><span class="p">))</span>  <span class="c1"># To handle ~ expansion</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">auxfile</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">subjects</span><span class="p">)</span>

    <span class="n">ctmargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mg2&quot;</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
        <span class="n">recache</span><span class="o">=</span><span class="n">recache</span><span class="p">,</span>
        <span class="n">external_svg</span><span class="o">=</span><span class="n">overlay_file</span><span class="p">,</span>
        <span class="n">overlays_available</span><span class="o">=</span><span class="n">overlays_available</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ctms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">subj</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_ctmpack</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="o">**</span><span class="n">ctmargs</span><span class="p">))</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">)</span>
    <span class="n">package</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">ctms</span><span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">auxfile</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">## Rename files to anonymize</span>
    <span class="n">submap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">ctmfile</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctms</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">oldpath</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ctmfile</span><span class="p">)</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anonymize</span><span class="p">:</span>
            <span class="n">newfname</span> <span class="o">=</span> <span class="s2">&quot;S</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">submap</span><span class="p">[</span><span class="n">subj</span><span class="p">]</span> <span class="o">=</span> <span class="n">newfname</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newfname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="n">ctms</span><span class="p">[</span><span class="n">subj</span><span class="p">]</span> <span class="o">=</span> <span class="n">newfname</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>

        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;ctm&quot;</span><span class="p">,</span> <span class="s2">&quot;svg&quot;</span><span class="p">]:</span>
            <span class="n">srcfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">oldpath</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
            <span class="n">newfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newfname</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newfile</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">newfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">copy_ctmfiles</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">srcfile</span><span class="p">,</span> <span class="n">newfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span> <span class="ow">and</span> <span class="n">anonymize</span><span class="p">:</span>
                <span class="c1">## change filenames in json</span>
                <span class="n">nfh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">newfile</span><span class="p">)</span>
                <span class="n">jsoncontents</span> <span class="o">=</span> <span class="n">nfh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">nfh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">ofh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">newfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
                <span class="n">ofh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsoncontents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newfname</span><span class="p">))</span>
                <span class="n">ofh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">anonymize</span><span class="p">:</span>
        <span class="n">old_subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ctms</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">ctms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="s2">&quot;S</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">ctms</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">old_subjects</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">submap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">submap</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Process the data</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;data/</span><span class="si">{name}</span><span class="s2">_</span><span class="si">{frame}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">submap</span><span class="o">=</span><span class="n">submap</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">images</span>
    <span class="c1"># Write out the PNGs</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">imgs</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">impath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{name}</span><span class="s2">_</span><span class="si">{frame}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impath</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">i</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">binfile</span><span class="p">:</span>
                <span class="n">binfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="c1"># Copy any stimulus files</span>
    <span class="n">stimpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;stim&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;stim&quot;</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stimpath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stimpath</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">],</span> <span class="n">stimpath</span><span class="p">)</span>

    <span class="c1"># Parse the html file and paste all the js and css files directly into the html</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">htmlembed</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
        <span class="c1">## Load locally</span>
        <span class="n">templatedir</span><span class="p">,</span> <span class="n">templatefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">template</span><span class="p">))</span>
        <span class="n">rootdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">templatedir</span><span class="p">,</span> <span class="n">serve</span><span class="o">.</span><span class="n">cwd</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">## Load system templates</span>
        <span class="n">templatefile</span> <span class="o">=</span> <span class="n">template</span>
        <span class="n">rootdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">serve</span><span class="o">.</span><span class="n">cwd</span><span class="p">]</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">FallbackLoader</span><span class="p">(</span><span class="n">rootdirs</span><span class="p">)</span>
    <span class="n">tpl</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">templatefile</span><span class="p">)</span>

    <span class="c1"># Put together all view options</span>
    <span class="n">my_viewopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s2">&quot;webgl_viewopts&quot;</span><span class="p">))</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;overlays_visible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlays_visible</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;labels_visible&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_visible</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;brightness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;brightness&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_brightness</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_brightness</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;contrast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;contrast&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_contrast</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_contrast</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;smoothness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;webgl_smooth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_smoothness</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_smoothness</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;specularity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;webgl_viewopts&quot;</span><span class="p">,</span> <span class="s2">&quot;specularity&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">surface_specularity</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">surface_specularity</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;paths&quot;</span> <span class="ow">in</span> <span class="n">sec</span> <span class="ow">or</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">:</span>
            <span class="n">my_viewopts</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">sec</span><span class="p">))</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">tpl</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">),</span>
        <span class="n">colormaps</span><span class="o">=</span><span class="n">colormaps</span><span class="p">,</span>
        <span class="n">default_cmap</span><span class="o">=</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span>
        <span class="n">python_interface</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">leapmotion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
        <span class="n">subjects</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">ctms</span><span class="p">),</span>
        <span class="n">viewopts</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">my_viewopts</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">desthtml</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">html_embed</span><span class="p">:</span>
        <span class="n">htmlembed</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">desthtml</span><span class="p">,</span> <span class="n">rootdirs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">desthtml</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">htmlfile</span><span class="p">:</span>
            <span class="n">htmlfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></div>



<div class="viewcode-block" id="show">
<a class="viewcode-back" href="../../../generated/cortex.webgl.show.html#cortex.webgl.show">[docs]</a>
<span class="k">def</span> <span class="nf">show</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">autoclose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">open_browser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pickerfun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">recache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;mixer.html&quot;</span><span class="p">,</span>
    <span class="n">overlays_available</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overlays_visible</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rois&quot;</span><span class="p">,</span> <span class="s2">&quot;sulci&quot;</span><span class="p">),</span>
    <span class="n">labels_visible</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;rois&quot;</span><span class="p">,),</span>
    <span class="n">types</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;inflated&quot;</span><span class="p">,),</span>
    <span class="n">overlay_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_brightness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_contrast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">curvature_smoothness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">surface_specularity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Brain&quot;</span><span class="p">,</span>
    <span class="n">layout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a webGL MRI viewer that is dynamically served by a tornado server</span>
<span class="sd">    running inside the current python process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : Dataset object or implicit Dataset</span>
<span class="sd">        Dataset object containing all the data you wish to plot. Can be any type</span>
<span class="sd">        of implicit dataset, such as a single Volume, Vertex, etc. object or a</span>
<span class="sd">        dictionary of Volume, Vertex. etc. objects.</span>
<span class="sd">    autoclose : bool, optional</span>
<span class="sd">        If True, the tornado server will automatically be destroyed when the last</span>
<span class="sd">        web client has disconnected. If False, the server will stay open,</span>
<span class="sd">        allowing more connections. Default True</span>
<span class="sd">    open_browser : bool, optional</span>
<span class="sd">        If True, uses the webbrowser library to open the viewer in the default</span>
<span class="sd">        local browser. Default True</span>
<span class="sd">    port : int or None, optional</span>
<span class="sd">        The port that will be used by the server. If None, a random port will be</span>
<span class="sd">        selected from the range 1024-65536. Default None</span>
<span class="sd">    pickerfun : function or None, optional</span>
<span class="sd">        Should be a function that takes two arguments, a voxel index and a vertex</span>
<span class="sd">        index. Is called whenever a location on the surface is clicked in the</span>
<span class="sd">        viewer. This can be used to print information about individual voxels or</span>
<span class="sd">        vertices, plot receptive fields, or many other uses. Default None</span>
<span class="sd">    recache : bool, optional</span>
<span class="sd">        Force recreation of CTM and SVG files for surfaces. Default False</span>
<span class="sd">    template : string, optional</span>
<span class="sd">        Name of template HTML file. Default &#39;mixer.html&#39;</span>
<span class="sd">    overlays_available : tuple, optional</span>
<span class="sd">        Overlays available in the viewer. If None, then all overlay layers of the</span>
<span class="sd">        svg file will be potentially available in the viewer (whether initially</span>
<span class="sd">        visible or not). </span>
<span class="sd">    overlays_visible : tuple, optional</span>
<span class="sd">        The listed overlay layers will be set visible by default. Layers not listed</span>
<span class="sd">        here will be hidden by default (but can be enabled in the viewer GUI).</span>
<span class="sd">        Default (&#39;rois&#39;, &#39;sulci&#39;)</span>
<span class="sd">    labels_visible : tuple, optional</span>
<span class="sd">        Labels for the listed layers will be set visible by default. Labels for</span>
<span class="sd">        layers not listed here will be hidden by default (but can be enabled in</span>
<span class="sd">        the viewer GUI). Default (&#39;rois&#39;, )</span>

<span class="sd">    Other parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    types : tuple, optional</span>
<span class="sd">        Types of surfaces to include in addition to the original (fiducial, pial,</span>
<span class="sd">        and white matter) and flat surfaces. Default (&#39;inflated&#39;, )</span>
<span class="sd">    overlay_file : str or None, optional</span>
<span class="sd">        Custom overlays.svg file to use instead of the default one for this</span>
<span class="sd">        subject (if not None). Default None.</span>
<span class="sd">    curvature_brightness : float or None, optional</span>
<span class="sd">        Brightness of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    curvature_contrast : float or None, optional</span>
<span class="sd">        Contrast of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    curvature_smoothness : float or None, optional</span>
<span class="sd">        Smoothness of curvature overlay. Default None, which uses the value</span>
<span class="sd">        specified in the config file.</span>
<span class="sd">    surface_specularity : float or None, optional</span>
<span class="sd">        Specularity of surfaces visualized with the WebGL viewer. </span>
<span class="sd">        Default None, which uses the value specified in the config file under</span>
<span class="sd">        `webgl_viewopts.specularity`.</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        The title that is displayed on the viewer website when it is loaded in</span>
<span class="sd">        a browser.</span>
<span class="sd">    layout : None or list of (int, int), optional</span>
<span class="sd">        The layout of the viewer subwindows for showing multiple subjects, passed to</span>
<span class="sd">        the template generator.</span>
<span class="sd">        Default None, corresponding to no subwindows.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        All additional keyword arguments are passed to the template renderer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># populate default webshow args</span>
    <span class="k">if</span> <span class="n">autoclose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">autoclose</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;webshow&#39;</span><span class="p">,</span> <span class="s1">&#39;autoclose&#39;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    <span class="k">if</span> <span class="n">open_browser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">open_browser</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;webshow&#39;</span><span class="p">,</span> <span class="s1">&#39;open_browser&#39;</span><span class="p">,</span> <span class="n">fallback</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">FallbackLoader</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">template</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span> <span class="n">serve</span><span class="o">.</span><span class="n">cwd</span><span class="p">])</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">auxfile</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1">#Extract the list of stimuli, for special-casing</span>
    <span class="n">stims</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;stim&#39;</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]):</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">stims</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;stim&#39;</span><span class="p">]</span>

    <span class="n">package</span> <span class="o">=</span> <span class="n">Package</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">metadata</span><span class="p">())</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">images</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">subjects</span><span class="p">)</span>

    <span class="n">ctmargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;mg2&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">recache</span><span class="o">=</span><span class="n">recache</span><span class="p">,</span>
        <span class="n">external_svg</span><span class="o">=</span><span class="n">overlay_file</span><span class="p">,</span> <span class="n">overlays_available</span><span class="o">=</span><span class="n">overlays_available</span><span class="p">)</span>
    <span class="n">ctms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">subj</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_ctmpack</span><span class="p">(</span><span class="n">subj</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="o">**</span><span class="n">ctmargs</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">)</span>
    <span class="n">package</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">ctms</span><span class="p">)</span>

    <span class="n">subjectjs</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">subj</span><span class="p">,</span> <span class="s2">&quot;ctm/</span><span class="si">%s</span><span class="s2">/&quot;</span><span class="o">%</span><span class="n">subj</span><span class="p">)</span> <span class="k">for</span> <span class="n">subj</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">auxfile</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="n">linear</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span><span class="o">*</span><span class="n">y</span>
    <span class="n">mixes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">linear</span><span class="o">=</span><span class="n">linear</span><span class="p">,</span>
        <span class="n">smoothstep</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">3</span><span class="p">)),</span>
        <span class="n">smootherstep</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">15</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">m</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">post_name</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="c1"># Put together all view options</span>
    <span class="n">my_viewopts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="s1">&#39;webgl_viewopts&#39;</span><span class="p">))</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s1">&#39;overlays_visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlays_visible</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s1">&#39;labels_visible&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_visible</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;brightness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;brightness&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_brightness</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_brightness</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;contrast&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;contrast&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_contrast</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_contrast</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;smoothness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;curvature&quot;</span><span class="p">,</span> <span class="s2">&quot;webgl_smooth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curvature_smoothness</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">curvature_smoothness</span>
    <span class="p">)</span>
    <span class="n">my_viewopts</span><span class="p">[</span><span class="s2">&quot;specularity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;webgl_viewopts&quot;</span><span class="p">,</span> <span class="s2">&quot;specularity&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">surface_specularity</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">else</span> <span class="n">surface_specularity</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;paths&#39;</span> <span class="ow">in</span> <span class="n">sec</span> <span class="ow">or</span> <span class="s1">&#39;labels&#39;</span> <span class="ow">in</span> <span class="n">sec</span><span class="p">:</span>
            <span class="n">my_viewopts</span><span class="p">[</span><span class="n">sec</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">sec</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pickerfun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pickerfun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="kc">None</span>

    <span class="k">class</span> <span class="nc">CTMHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">subj</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/json&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">ctms</span><span class="p">[</span><span class="n">subj</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ctms</span><span class="p">[</span><span class="n">subj</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mtype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">mtype</span> <span class="o">=</span> <span class="s2">&quot;application/octet-stream&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">class</span> <span class="nc">DataHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataname</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="n">dataimg</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">dataimg</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NUMPY&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;image/png&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;Range&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">206</span><span class="p">)</span>
                    <span class="n">rangestr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rangestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="p">]</span>

                    <span class="n">clenheader</span> <span class="o">=</span> <span class="s1">&#39;bytes </span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataimg</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataimg</span><span class="p">)</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">,</span> <span class="n">clenheader</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dataimg</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dataimg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">StimHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stims</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">stims</span><span class="p">[</span><span class="n">path</span><span class="p">])</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">StimHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">StaticHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">class</span> <span class="nc">MixerHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                                      <span class="n">colormaps</span><span class="o">=</span><span class="n">colormaps</span><span class="p">,</span>
                                      <span class="n">default_cmap</span><span class="o">=</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span>
                                      <span class="n">python_interface</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">leapmotion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">layout</span><span class="o">=</span><span class="n">layout</span><span class="p">,</span>
                                      <span class="n">subjects</span><span class="o">=</span><span class="n">subjectjs</span><span class="p">,</span>
                                      <span class="n">viewopts</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">my_viewopts</span><span class="p">),</span>
                                      <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                      <span class="c1">#overlays_visible=json.dumps(overlays_visible),</span>
                                      <span class="c1">#labels_visible=json.dumps(labels_visible),</span>
                                      <span class="c1">#**viewopts)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">png</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">post_name</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">svgfile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">png</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">png</span><span class="p">[</span><span class="mi">22</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_base64</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error writing image!&quot;</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">png</span>
                <span class="n">svgfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">JSMixer</span><span class="p">(</span><span class="n">serve</span><span class="o">.</span><span class="n">JSProxy</span><span class="p">):</span>
        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">view_props</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;An enumerated list of settable properties for views. </span>
<span class="sd">            There may be a way to get this from the javascript object, </span>
<span class="sd">            but I (ML) don&#39;t know how.</span>

<span class="sd">            There may be additional properties we want to set in views</span>
<span class="sd">            and animations; those must be added here.</span>

<span class="sd">            Old property list that used to be settable before webgl refactor:</span>
<span class="sd">            view_props = [&#39;altitude&#39;, &#39;azimuth&#39;, &#39;target&#39;, &#39;mix&#39;, &#39;radius&#39;, &#39;pivot&#39;,</span>
<span class="sd">                &#39;visL&#39;, &#39;visR&#39;, &#39;alpha&#39;, &#39;rotationR&#39;, &#39;rotationL&#39;, &#39;projection&#39;,</span>
<span class="sd">                &#39;volume_vis&#39;, &#39;frame&#39;, &#39;slices&#39;]</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">camera</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;camera&quot;</span><span class="p">)</span>
            <span class="n">_camera_props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;camera.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">camera</span><span class="o">.</span><span class="n">_controls</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">)</span>
            <span class="n">_subject</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">surface</span><span class="o">.</span><span class="n">_folders</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_surface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">surface</span><span class="p">,</span> <span class="n">_subject</span><span class="p">)</span>
            <span class="n">_surface_props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_surface</span><span class="o">.</span><span class="n">_controls</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">_curvature_props</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.curvature.brightness&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.curvature.contrast&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.curvature.smoothness&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">_camera_props</span> <span class="o">+</span> <span class="n">_surface_props</span> <span class="o">+</span> <span class="n">_curvature_props</span>

        <span class="k">def</span> <span class="nf">_set_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Low-level command: sets view parameters in the current viewer</span>

<span class="sd">            Sets each the state of each keyword argument provided. View parameters</span>
<span class="sd">            that can be set include all parameters in the data.gui in the html view.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Set unfolding level first, as it interacts with other arguments</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="s2">&quot;surface&quot;</span><span class="p">)</span>
            <span class="n">subject_list</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">_folders</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="c1"># Better to only self.view_props once; it interacts with javascript, </span>
            <span class="c1"># don&#39;t want to do that too often, it leads to glitches.</span>
            <span class="n">vw_props</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_props</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subject_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.unfold&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">unfold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.unfold&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;surface.</span><span class="si">{subject}</span><span class="s1">.unfold&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">),</span> <span class="n">unfold</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vw_props</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown parameter </span><span class="si">%s</span><span class="s1">!&#39;</span><span class="o">%</span><span class="n">k</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{subject}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">else</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="c1"># Wait for webgl. Wait for it. .... WAAAAAIIIT.</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_capture_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Low-level command: returns a dict of current view parameters</span>

<span class="sd">            Retrieves the following view parameters from current viewer:</span>

<span class="sd">            altitude, azimuth, target, mix, radius, visL, visR, alpha,</span>
<span class="sd">            rotationR, rotationL, projection, pivot</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            frame_time : scalar</span>
<span class="sd">                time (in seconds) to specify for this frame.</span>
<span class="sd">            </span>
<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            If multiple subjects are present, only retrieves view for first subject.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">view</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">subject</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">surface</span><span class="o">.</span><span class="n">_folders</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_props</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">view</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{subject}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">p</span> <span class="k">else</span> <span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Wait for webgl.</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="c1"># TO DO: Fix this hack with an error class in serve.py &amp; catch it here</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="c1">#msg = &quot;Cannot read property &#39;undefined&#39;&quot;</span>
                    <span class="c1">#if err.message[:len(msg)] != msg:</span>
                    <span class="c1">#    raise err</span>
            <span class="k">if</span> <span class="n">frame_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">view</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frame_time</span>
            <span class="k">return</span> <span class="n">view</span>

        <span class="k">def</span> <span class="nf">save_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Saves current view parameters to pycortex database</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            subject : string</span>
<span class="sd">                pycortex subject id</span>
<span class="sd">            name : string</span>
<span class="sd">                name for view to store</span>
<span class="sd">            is_overwrite: bool</span>
<span class="sd">                whether to overwrite an extant view (default : False)</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Equivalent to call to cortex.db.save_view(subject, vw, name)</span>
<span class="sd">            For a list of the view parameters saved, see viewer._capture_view</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">db</span><span class="o">.</span><span class="n">save_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">is_overwrite</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get saved view from pycortex database.</span>

<span class="sd">            Retrieves named view from pycortex database and sets current</span>
<span class="sd">            viewer parameters to retrieved values.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            subject : string</span>
<span class="sd">                pycortex subject ID</span>
<span class="sd">            name : string</span>
<span class="sd">                name of saved view to re-load</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Equivalent to call to cortex.db.get_view(subject, vw, name)</span>
<span class="sd">            For a list of the view parameters set, see viewer._capture_view</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">addData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">Proxy</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">JSProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="s2">&quot;window.viewers.addData&quot;</span><span class="p">)</span>
            <span class="n">new_meta</span><span class="p">,</span> <span class="n">new_ims</span> <span class="o">=</span> <span class="n">_convert_dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/data/&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.png&#39;</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_meta</span><span class="p">)</span>
            <span class="n">images</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_ims</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">getImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">)):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Saves currently displayed view to a .png image file</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            filename : string</span>
<span class="sd">                duh.</span>
<span class="sd">            size : tuple (x, y)</span>
<span class="sd">                size (in pixels) of image to save.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">post_name</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">Proxy</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">JSProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="s2">&quot;window.viewer.getImage&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Proxy</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;mixer.html&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">makeMovie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;brainmovie</span><span class="si">%07d</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Renders movie frames for animation of mesh movement</span>

<span class="sd">            Makes an animation (for example, a transition between inflated and</span>
<span class="sd">            flattened brain or a rotating brain) of a cortical surface. Takes a</span>
<span class="sd">            list of dictionaries (`animation`) as input, and uses the values in</span>
<span class="sd">            the dictionaries as keyframes for the animation.</span>

<span class="sd">            Mesh display parameters that can be animated include &#39;elevation&#39;,</span>
<span class="sd">            &#39;azimuth&#39;, &#39;mix&#39;, &#39;radius&#39;, &#39;target&#39; (more?)</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            animation : list of dicts</span>
<span class="sd">                Each dict should have keys `idx`, `state`, and `value`.</span>
<span class="sd">                `idx` is the time (in seconds) at which you want to set `state` to `value`</span>
<span class="sd">                `state` is the parameter to animate (e.g. &#39;altitude&#39;, &#39;azimuth&#39;)</span>
<span class="sd">                `value` is the value to set for `state`</span>
<span class="sd">            filename : string path name</span>
<span class="sd">                Must contain &#39;%d&#39; (or some variant thereof) to account for frame</span>
<span class="sd">                number, e.g. &#39;/some/directory/brainmovie%07d.png&#39;</span>
<span class="sd">            offset : int</span>
<span class="sd">                Frame number for first frame rendered. Useful for concatenating</span>
<span class="sd">                animations.</span>
<span class="sd">            fps : int</span>
<span class="sd">                Frame rate of resultant movie</span>
<span class="sd">            size : tuple (x, y)</span>
<span class="sd">                Size (in pixels) of resulting movie</span>
<span class="sd">            interpolation : {&quot;linear&quot;, &quot;smoothstep&quot;, &quot;smootherstep&quot;}</span>
<span class="sd">                Interpolation method for values between keyframes.</span>

<span class="sd">            Example</span>
<span class="sd">            -------</span>
<span class="sd">            # Called after a call of the form: js_handle = cortex.webgl.show(DataViewObject)</span>
<span class="sd">            # Start with left hemisphere view</span>
<span class="sd">            js_handle._setView(azimuth=[90], altitude=[90.5], mix=[0])</span>
<span class="sd">            # Initialize list</span>
<span class="sd">            animation = []</span>
<span class="sd">            # Append 5 key frames for a simple rotation</span>
<span class="sd">            for az, idx in zip([90, 180, 270, 360, 450], [0, .5, 1.0, 1.5, 2.0]):</span>
<span class="sd">                animation.append({&#39;state&#39;:&#39;azimuth&#39;, &#39;idx&#39;:idx, &#39;value&#39;:[az]})</span>
<span class="sd">            # Animate! (use default settings)</span>
<span class="sd">            js_handle.makeMovie(animation)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># build up two variables: State and Anim.</span>
            <span class="c1"># state is a dict of all values being modified at any time</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c1"># anim is a list of transitions between keyframes</span>
            <span class="n">anim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">setfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">set</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">setfunc</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">val</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                        <span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]][</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span>
                                 <span class="n">state</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span>
                                 <span class="n">value</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">],</span> <span class="n">state</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span> <span class="n">value</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                        <span class="n">anim</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">anim</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="o">/</span><span class="n">fps</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">fps</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">anim</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sec</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">sec</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;frame&#39;</span><span class="p">:</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">mixes</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">mixes</span><span class="p">[</span><span class="n">interpolation</span><span class="p">]</span>

                        <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]),</span> <span class="n">idx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="n">setfunc</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span> <span class="n">val</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">setfunc</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getImage</span><span class="p">(</span><span class="n">filename</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">offset</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_anim_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyframes</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert a list of keyframes to a list of EVERY frame in an animation.</span>

<span class="sd">            Utility function called by make_movie; separated out so that individual</span>
<span class="sd">            frames of an animation can be re-rendered, or for more control over the</span>
<span class="sd">            animation process in general.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Misc. setup</span>
            <span class="n">fr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">mixes</span><span class="p">[</span><span class="n">interpolation</span><span class="p">]</span>
            <span class="c1">#skip_props = [&#39;surface.{subject}.right&#39;, &#39;surface.{subject}.left&#39;, ] #&#39;projection&#39;,</span>
            <span class="c1"># Get keyframes</span>
            <span class="n">keyframes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keyframes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
            <span class="c1"># Normalize all time to frame rate</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">fps</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keyframes</span><span class="p">)):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span>
                <span class="n">keyframes</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">allframes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keyframes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">keyframes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">end</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                <span class="n">tdif</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
                <span class="c1"># Check whether to continue frame sequence to endpoint</span>
                <span class="n">use_endpoint</span> <span class="o">=</span> <span class="n">keyframes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">end</span>
                <span class="n">nvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">tdif</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">use_endpoint</span><span class="p">:</span>
                    <span class="n">nvalues</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">fr_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nvalues</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">use_endpoint</span><span class="p">)</span>
                <span class="c1"># Interpolate between values</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fr_time</span><span class="p">:</span>
                    <span class="n">frame</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">start</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">prop</span><span class="o">==</span><span class="s1">&#39;time&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">==</span> <span class="n">end</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">prop</span><span class="p">],</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                            <span class="n">frame</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">prop</span><span class="p">]),</span> <span class="n">a</span><span class="p">(</span><span class="n">end</span><span class="p">[</span><span class="n">prop</span><span class="p">]),</span> <span class="n">t</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="n">frame</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">frame</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">allframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">allframes</span>

        <span class="k">def</span> <span class="nf">make_movie_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">animation</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;brainmovie</span><span class="si">%07d</span><span class="s2">.png&quot;</span><span class="p">,</span> 
            <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_sleep</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">frame_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Renders movie frames for animation of mesh movement</span>

<span class="sd">            Makes an animation (for example, a transition between inflated and</span>
<span class="sd">            flattened brain or a rotating brain) of a cortical surface. Takes a</span>
<span class="sd">            list of dictionaries (`animation`) as input, and uses the values in</span>
<span class="sd">            the dictionaries as keyframes for the animation.</span>

<span class="sd">            Mesh display parameters that can be animated include &#39;elevation&#39;,</span>
<span class="sd">            &#39;azimuth&#39;, &#39;mix&#39;, &#39;radius&#39;, &#39;target&#39; (more?)</span>


<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            animation : list of dicts</span>
<span class="sd">                This is a list of keyframes for the animation. Each keyframe should be</span>
<span class="sd">                a dict in the form captured by the ._capture_view method. NOTE: every</span>
<span class="sd">                view must include all view parameters. Additionally, there should be</span>
<span class="sd">                one extra key/value pair for &quot;time&quot;. The value for time should be</span>
<span class="sd">                in seconds. The list of keyframes is sorted by time before applying,</span>
<span class="sd">                so they need not be in order in the input.</span>
<span class="sd">            filename : string path name</span>
<span class="sd">                Must contain &#39;%d&#39; (or some variant thereof) to account for frame</span>
<span class="sd">                number, e.g. &#39;/some/directory/brainmovie%07d.png&#39;</span>
<span class="sd">            offset : int</span>
<span class="sd">                Frame number for first frame rendered. Useful for concatenating</span>
<span class="sd">                animations.</span>
<span class="sd">            fps : int</span>
<span class="sd">                Frame rate of resultant movie</span>
<span class="sd">            size : tuple (x, y)</span>
<span class="sd">                Size (in pixels) of resulting movie</span>
<span class="sd">            interpolation : {&quot;linear&quot;, &quot;smoothstep&quot;, &quot;smootherstep&quot;}</span>
<span class="sd">                Interpolation method for values between keyframes.</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            Make sure that all values that will be modified over the course</span>
<span class="sd">            of the animation are initialized (have some starting value) in the first</span>
<span class="sd">            frame.</span>

<span class="sd">            Example</span>
<span class="sd">            -------</span>
<span class="sd">            # Called after a call of the form: js_handle = cortex.webgl.show(DataViewObject)</span>
<span class="sd">            # Start with left hemisphere view</span>
<span class="sd">            js_handle._setView(azimuth=[90], altitude=[90.5], mix=[0])</span>
<span class="sd">            # Initialize list</span>
<span class="sd">            animation = []</span>
<span class="sd">            # Append 5 key frames for a simple rotation</span>
<span class="sd">            for az, t in zip([90, 180, 270, 360, 450], [0, .5, 1.0, 1.5, 2.0]):</span>
<span class="sd">                animation.append({&#39;time&#39;:t, &#39;azimuth&#39;:[az]})</span>
<span class="sd">            # Animate! (use default settings)</span>
<span class="sd">            js_handle.make_movie(animation)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">allframes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_anim_seq</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="n">interpolation</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">allframes</span><span class="p">[</span><span class="n">frame_start</span><span class="p">:],</span> <span class="n">frame_start</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_view</span><span class="p">(</span><span class="o">**</span><span class="n">frame</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">frame_sleep</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">getImage</span><span class="p">(</span><span class="n">filename</span><span class="o">%</span><span class="p">(</span><span class="n">fr</span><span class="o">+</span><span class="n">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">frame_sleep</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">PickerHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">pickerfun</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;voxel&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s2">&quot;vertex&quot;</span><span class="p">)))</span>

    <span class="k">class</span> <span class="nc">WebApp</span><span class="p">(</span><span class="n">serve</span><span class="o">.</span><span class="n">WebApp</span><span class="p">):</span>
        <span class="n">disconnect_on_close</span> <span class="o">=</span> <span class="n">autoclose</span>
        <span class="k">def</span> <span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">JSMixer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="s2">&quot;window.viewer&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_local_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JSMixer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srvsend</span><span class="p">,</span> <span class="s2">&quot;window.viewer&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">65536</span><span class="p">)</span>

    <span class="n">server</span> <span class="o">=</span> <span class="n">WebApp</span><span class="p">([(</span><span class="sa">r</span><span class="s1">&#39;/ctm/(.*)&#39;</span><span class="p">,</span> <span class="n">CTMHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/data/(.*)&#39;</span><span class="p">,</span> <span class="n">DataHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/stim/(.*)&#39;</span><span class="p">,</span> <span class="n">StimHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/mixer.html&#39;</span><span class="p">,</span> <span class="n">MixerHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/picker&#39;</span><span class="p">,</span> <span class="n">PickerHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">MixerHandler</span><span class="p">),</span>
                     <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/static/(.*)&#39;</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">)],</span>
                    <span class="n">port</span><span class="p">)</span>

    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Started server on port </span><span class="si">%d</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">/mixer.html&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">serve</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">domain_name</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">open_browser</span><span class="p">:</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="k">return</span> <span class="n">client</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
            <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;Open viewer: &lt;a href=&quot;</span><span class="si">{0}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;</span><span class="si">{0}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">server</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pycortex</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=gallantlab&repo=pycortex&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../segmentation_guide.html">Surface Segmentation and Flattening</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database.html">Surface Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../align.html">Alignments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rois.html">Surface-defined ROIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transforms.html">Transform formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../colormaps.html">Colormaps</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Example Gallery</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference_flat.html">Python API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2012, James Gao.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>